name: snowflake-devops-demo

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy-snowflake-changes-job:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env: [dev, prod]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Use Python 3.8.x
        uses: actions/setup-python@v2.2.1
        with:
          python-version: 3.8.x

      - name: Set environment variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            export SF_ACCOUNT="${{ secrets.PROD_SF_ACCOUNT }}"
            export SF_USERNAME="${{ secrets.PROD_SF_USERNAME }}"
            export SF_PASSWORD="${{ secrets.PROD_SF_PASSWORD }}"
            export SF_ROLE="${{ secrets.PROD_SF_ROLE }}"
            export SF_WAREHOUSE="${{ secrets.PROD_SF_WAREHOUSE }}"
            export SF_DATABASE="${{ secrets.PROD_SF_DATABASE }}"
          else
            export SF_ACCOUNT="${{ secrets.DEV_SF_ACCOUNT }}"
            export SF_USERNAME="${{ secrets.DEV_SF_USERNAME }}"
            export SF_PASSWORD="${{ secrets.DEV_SF_PASSWORD }}"
            export SF_ROLE="${{ secrets.DEV_SF_ROLE }}"
            export SF_WAREHOUSE="${{ secrets.DEV_SF_WAREHOUSE }}"
            export SF_DATABASE="${{ secrets.DEV_SF_DATABASE }}"
          fi

      - name: Run schemachange
        env:
          SF_ACCOUNT: ${{ env.SF_ACCOUNT }}
          SF_USERNAME: ${{ env.SF_USERNAME }}
          SF_ROLE: ${{ secrets.SF_ROLE }}
          SF_WAREHOUSE: ${{ secrets.SF_WAREHOUSE }}
          SF_DATABASE: ${{ secrets.SF_DATABASE }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SF_PASSWORD }}
        run: |
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          python --version
          echo "Step 1: Installing schemachange"
          pip install schemachange
          echo "Step 2: Running schemachange"
          schemachange -f $GITHUB_WORKSPACE/ -a $SF_ACCOUNT -u $SF_USERNAME -r $SF_ROLE -w $SF_WAREHOUSE -d $SF_DATABASE -c $SF_DATABASE.SCHEMACHANGE.CHANGE_HISTORY --create-change-history-table
